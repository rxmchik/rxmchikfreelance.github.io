var aaa,aab,aac,aad,aae,aaf,aag,aah,aai;var aaj=30;var aak={};document.addEventListener('DOMContentLoaded',function(){window.addEventListener("message",function(e){if(e.source!=window){return;}if(e.data.type){if(e.data.d && e.data.d.d){}if(e.data.type==".f"){aal(e.data.d,aaa);}if(e.data.type=="f"){$('#fr_status').show();if(e.data.d&&e.data.d.ver){ver=e.data.d.ver;}if(ver==1){$("body").append("<div id='info_window'>Обновите расширение Frontpad.Коннектор. Подробности в справке по<a href='frontpad.ru/help/?help=1022#install' target='_blank'>ссылке</a>.<span onclick=\"$('#info_window').hide();\">Закрыть</span></div>");}}if(e.data.type=="c"){ca=ce=1;$('#fr_status div').removeClass('m_fr_dis').addClass('m_fr_en');aam();$('.aan').css('display','block');}if(e.data.type=="d"){ca=ce=0;$('#fr_status div').removeClass('m_fr_en').addClass('m_fr_dis');$('.aan').css('display','none');}}},false);});function aao(){var d="<h2 align='center'>Чек напечатан?</h2><p align='center'>Программа не получила ответ от фискального регистратора</p><p class='popup_buttons'><span onclick='aap();' class='btn save'>Да,сохранить заказ</span><span onclick='aaq();' class='btn grey'>Нет,закрыть</span></p>";popupShow(d);}function aap(){aac='';if(aai){orderSend(aai.p,aai.t);}}function aaq(){aac='';windowClose();}function aar(u){return "blocks/function/"+u+".php";}function aas(e){post(aar('fr'),"error="+e+"<"+aad+","+aae+","+aaf+">",function(data){});}function aat(){post(aar('fr'),"connect=<"+aad+","+aae+","+aaf+">",function(data){});}function aau(d,f){if(navigator.onLine){if(aac=='inProgress'){var tmp="Ожидайте окончания выполнения предыдущей команды";statusType('error',tmp);aas(tmp);}else{loadingShow();if(f){aaa=f;}window.postMessage({type: "f.",d: d},"*");aac='inProgress';if(aab=="sell"||aab=="sellReturn"||aab=="nonFiscal"){aag=setTimeout(function(){aao();},12000);}}}else{statusType('error',"Нет доступа к сети Интернет,проверьте подключение");}}function aal(d,f){if(d){aac=d.d.results[0].status;if(d.d.results[0].status=='error'){loadingHide();windowClose();clearTimeout(aag);statusType('error',d.d.results[0].errorDescription);aas(d.d.results[0].errorDescription);}else if(d.d.results[0].status=='ready'){loadingHide();if(aab!="getDeviceInfo"){if(aab=="sell"||aab=="sellReturn"||aab=="nonFiscal"){windowClose();}statusType('success',"Успешно");clearTimeout(aag);}if(f){f(d);}}else{}}}function aav(){var dt=new Date().getTime();var uuid='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=(dt+Math.random()*16)%16 | 0;dt=Math.floor(dt/16);return(c=='x' ? r :(r&0x3|0x8)).toString(16);});return uuid;}function aam(){aau(aaw('getDeviceInfo'),function(d){if(d.d.results[0].result.deviceInfo.receiptLineLength>0){aaj=d.d.results[0].result.deviceInfo.receiptLineLength;aad=d.d.results[0].result.deviceInfo.modelName;aae=d.d.results[0].result.deviceInfo.ffdVersion;aaf=d.d.results[0].result.deviceInfo.fnFfdVersion;aat();}});}function aax(data){var d=[];if(data.text){d.push({'type':'text','text':data.text,'alignment':'center','wrap':'words'});d.push({'type':'text','text':''});}if(data.url){d.push({'type':'barcode','barcode':data.url,'barcodeType':'QR','scale':5});d.push({'type':'text','text':''});}return d;}function aaw(t,p){aab=t;var d={};d['uuid']=aav();d['request']={};if(p){d['request']=p;}d['request']['type']=t;return JSON.stringify(d);}function aay(t,data){aab=t;aak['width']=aaj;aak['sep']=" ";aak['next']="\n";function aaz(s){var space="";var tm={};tm['type']='text';tm['text']="";for(i=0;i<aak['width'];i++){tm['text']+=s;}tm['alignment']="left";return tm;}function aba(v){d['request']['items'].push(v);}function abb(li){var el_max=[];var el_length=[];var result="";var razn=0;var line_length=0;if(li.length>2){el_max[2]=8;}else{el_max[2]=0;}el_max[1]=6;el_max[0]=aak['width']-el_max[1]-el_max[2];for(var key in li){el_length[key]=li[key].toString().length;line_length+=el_length[key];}for(var key in li){var space="";razn=el_max[key]-el_length[key];for(var i=0;i<razn;i++){space+=aak['sep'];}if(key==0){if(razn<1){for(var i=0;i<el_max[0];i++){space+=aak['sep'];}result+=li[key]+aak['next']+space;}else{result+=li[key]+space;}}else{result+=space+li[key];}}return result;}function abc(arr){if(arr['productID'].length>0){for(var i=0;i<=arr['productID'].length;i++){if(arr['name'][i]){var tm={};tm['type']='text';tm['text']=abb([arr['name'][i],Number(arr['kol'][i]),roundNum(arr['price'][i]*arr['kol'][i])]);tm['wrap']='words';d['request']['items'].push(tm);}}}}var d={};d['uuid']=aav();d['request']={};d['request']['type']=t;d['request']['printFooter']=false;d['request']['items']=[];aba(aaz(" "));aba(aaz(" "));aba({'type':'text','text':abb(["Наименование","Кол.","Цена"])});d['request']['items'].push(aaz("-"));abc(bill['positions']);abc(auto);abc(cert);aba(aaz("-"));aba({'type':'text','text':abb(["Сумма("+currency+")",bill['total0']])});if(bill['margin']){aba({'type':'text','text':abb(["Наценка",bill['margin']+"%"])});}if(bill['sale']){aba({'type':'text','text':abb(["Скидка",bill['sale']+"%"])});}if(bill['client_sale'] && gl_score!=2){aba({'type':'text','text':abb(["Скидка",bill['client_sale']+"%"])});}if(bill['cert_sale']){aba({'type':'text','text':abb(["Скидка",bill['cert_sale']+"%"])});}if(bill['u_sale']){aba({'type':'text','text':abb(["Скидка("+currency+")",bill['u_sale']])});}if(bill['cert_amount']){aba({'type':'text','text':abb(["Скидка("+currency+")",bill['cert_amount']])});}if(bill['totalS']>0){aba({'type':'text','text':abb(["Списано баллов",bill['totalS']])});}aba(aaz(" "));aba({'type':'text','text':abb(["К оплате("+currency+")",bill['total']]),'doubleHeight':true});aba(aaz(" "));if(data.q){d['request']['items']=d['request']['items'].concat(aax(data.q));}if(bill['person']>0||bill['table']>0){if(bill['person']>0){aba({'type':'text','text':"Персон: "+bill['person']+" "});}if(bill['table']>0){aba({'type':'text','text':"Стол: "+bill['table']});}}if($("#billName").val()){aba({'type':'text','text':"Имя: "+$("#billName").val(),'wrap':'words'});}if($("#billPhone").val()){aba({'type':'text','text':"Телефон: "+$("#billPhone").val(),'wrap':'words'});}aba(aaz(" "));if($("#billStreet").val()){aba({'type':'text','text':"Улица: "+$("#billStreet").val(),'wrap':'words'});}if($("#billHome").val()){aba({'type':'text','text':"Дом: "+$("#billHome").val(),'wrap':'words'});}if($("#billPod").val()){aba({'type':'text','text':"Подъезд: "+$("#billPod").val()});}if($("#billEt").val()){aba({'type':'text','text':"Этаж: "+$("#billEt").val()});}if($("#billKvart").val()){aba({'type':'text','text':"Квартира: "+$("#billKvart").val(),'wrap':'words'});}if($("#billDescr").val()){aba({'type':'text','text':"Примечание: "+$("#billDescr").val(),'wrap':'words'});}return JSON.stringify(d);}function abd(t,data){aab=t;abe();function abf(arr){if(arr['productID'].length>0){for(i=0;i<=arr['productID'].length;i++){if(arr['name'][i]){var tm={};tm['type']='position';tm['name']=arr['name'][i];tm['price']=Number(arr['price_'][i]);tm['quantity']=Number(arr['kol'][i]);tm['amount']=roundNum(arr['price_'][i]*arr['kol'][i]);if(aae>=1.2){tm['measurementUnit']=0;}if(arr['vat'][i] && arr['vat'][i]>=0){tm['tax']={type:'vat'+arr['vat'][i]};}else{tm['tax']={type:'none'};}if(arr['excise'][i]){tm['paymentObject']='excise';}d['request']['items'].push(tm);if(arr['price'][i]>arr['price_'][i]){var tm={};tm['type']='text';tm['text']='Скидка '+roundNum((arr['price'][i]-arr['price_'][i])*arr['kol'][i]);tm['alignment']='right';d['request']['items'].push(tm);}}}}}var d={};d['uuid']=aav();d['request']={};d['request']['type']=t;if(gs_oper_name){if(gs_oper_vatin){d['request']['operator']={name:gs_oper_name,vatin:gs_oper_vatin};}else{d['request']['operator']={name:gs_oper_name};};}if(data.e){d['request']['clientInfo']={emailOrPhone:data.e};d['request']['electronically']=true;}if(data.p=='cashles'){data.p='electronically';}d['request']['payments']=[{type:data.p,sum:Number(data.t)}];d['request']['items']=[];abf(bill['positions']);abf(auto);abf(cert);if(bill['margin']){var n='Наценка '+bill['margin']+'%';var m=roundNum(bill['margin_total']);abf({productID:[1],name:[n],kol:[1],price:[m],price_:[m],vat:[''],excise:['']});}if(data.q){d['request']['postItems']=aax(data.q);}return JSON.stringify(d);}function abe(){var abg;var abh=bill['cert_amount']+bill['u_sale']+bill['totalS'];function abi(){var abj=0;var abk;function abl(arr,t){if(arr['productID'].length>0){for(var i=0;i<=arr['productID'].length;i++){if(arr['kol'][i]>0){var abm=0;var abn=0;if(arr['sale'] && arr['sale'][i]==1){if(gl_score!=2 &&!gl_score_sale_block){abn=bill['client_sale'];}else{abn=0;}abm=bill['sale']+abn+bill['cert_sale'];}var abo=roundNum(arr['kol'][i]*arr['price'][i]);var abp=roundNum(abo/bill['total0'],5);var abq=roundNum(abh*abp/arr['kol'][i]);var abr=arr['price'][i]-arr['price'][i]*abm/100-abq;if(abk!=1 && abg!=0 && arr['price'][i]>=abg && arr['kol'][i]==1){abr+=abg;abk=1;}var abs=roundNum(arr['kol'][i]*abr);if(t=='b'){bill['positions']['price_'][i]=roundNum(abr);}if(t=='a'){auto['price_'][i]=roundNum(abr);}if(t=='c'){cert['price_'][i]=roundNum(abr);}abj+=abs;}}}}abl(bill['positions'],'b');abl(auto,'a',0);abl(cert,'c',0);if(bill['margin_total']>0){abj+=bill['margin_total'];}abg=roundNum(bill['total']-abj);}abi(0);if(abg!=0){abi(abg);}}function abt(){aau(aaw('getShiftStatus'));}function abu(){aau(aaw('openShift'));}function abv(){aau(aaw('closeShift'),function(){cbs();});}function abw(d){aai=d;aau(aay('nonFiscal',d),function(){});}function abx(d){aai=d;if($("#nonfiskal").is(":checked")){aah=1;}else{aah=0;}aau(abd('sell',d),function(){if(aah==1){cp();}orderSend(d.p,d.t);});}function aby(d){aai=d;aau(abd('sellReturn',d),function(){post(aar("orders"),"order_refound="+d.i,function(data){});menu('front','');windowClose();});}function abz(v){var p={cashSum:Number(v)};aau(aaw('cashIn',p),function(){cbs();});}function aca(v){var p={cashSum:Number(v)};aau(aaw('cashOut',p),function(){cbs();});}function acb(){aau(aaw('reportX'));}function acc(){aau(aaw('printLastReceiptCopy'));}function cb(p,s,e){abx({'p':p,'t':s,'e':e});}function cr(p,s,i){aby({'p':p,'t':s,'i':i});}function cp(p,s){abw({'p':p,'t':s});}function cc(){acc();}function ci(){if($("#popup #print_cash_oper").is(":checked")){var v=$("#popup #cash_value").val();if($("#popup #cashbox_oper").val()==1){abz(v);}else{aca(v);}}else{cbs();}}function cx(){acb();}function cz(){if($("#popup #print_cash_time").is(":checked")){abv();}else{cbs();}}function cbs(){sendForm('popup','cashbox','cashbox');}function ncb(d){abx(d);}function ncr(d){aby(d);}function ncp(d){abw(d);}